{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CAWS Working Spec",
  "type": "object",
  "required": ["id", "title", "risk_tier", "mode", "change_budget", "blast_radius", "operational_rollback_slo", "scope", "invariants", "acceptance", "non_functional", "contracts"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[A-Z]+-\\d+$",
      "description": "Project identifier (e.g., FEAT-1234)"
    },
    "title": {
      "type": "string",
      "minLength": 8,
      "description": "Descriptive project title"
    },
    "risk_tier": {
      "type": "integer",
      "enum": [1, 2, 3],
      "description": "Risk tier: 1 (critical), 2 (standard), 3 (low risk)"
    },
    "mode": {
      "type": "string",
      "enum": ["refactor", "feature", "fix", "doc", "chore"],
      "description": "Project mode"
    },
    "change_budget": {
      "type": "object",
      "properties": {
        "max_files": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of files to change"
        },
        "max_loc": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum lines of code to change"
        }
      },
      "required": ["max_files", "max_loc"],
      "additionalProperties": false
    },
    "blast_radius": {
      "type": "object",
      "properties": {
        "modules": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Modules affected by the change"
        },
        "data_migration": {
          "type": "boolean",
          "description": "Whether data migration is required"
        }
      },
      "required": ["modules", "data_migration"],
      "additionalProperties": false
    },
    "operational_rollback_slo": {
      "type": "string",
      "pattern": "^[0-9]+m$|^[0-9]+h$",
      "description": "Operational rollback SLO (e.g., 5m, 1h)"
    },
    "threats": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Potential threats and risks"
    },
    "scope": {
      "type": "object",
      "required": ["in", "out"],
      "properties": {
        "in": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Files/features in scope"
        },
        "out": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files/features out of scope"
        }
      }
    },
    "invariants": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "description": "System invariants that must be maintained"
    },
    "acceptance": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "given", "when", "then"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^A\\d+$",
            "description": "Acceptance criteria ID"
          },
          "given": {
            "type": "string",
            "description": "Given clause"
          },
          "when": {
            "type": "string",
            "description": "When clause"
          },
          "then": {
            "type": "string",
            "description": "Then clause"
          }
        }
      },
      "description": "Acceptance criteria in Given-When-Then format"
    },
    "non_functional": {
      "type": "object",
      "properties": {
        "a11y": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Accessibility requirements"
        },
        "perf": {
          "type": "object",
          "properties": {
            "api_p95_ms": {
              "type": "integer",
              "minimum": 1,
              "description": "API p95 latency in milliseconds"
            },
            "lcp_ms": {
              "type": "integer",
              "minimum": 1,
              "description": "Largest Contentful Paint in milliseconds"
            }
          },
          "additionalProperties": false
        },
        "security": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Security requirements"
        }
      },
      "additionalProperties": false
    },
    "contracts": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["type", "path"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["openapi", "graphql", "proto", "pact"],
            "description": "Contract type"
          },
          "path": {
            "type": "string",
            "description": "Path to contract specification"
          }
        }
      }
    },
    "observability": {
      "type": "object",
      "properties": {
        "logs": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Log events to emit"
        },
        "metrics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Metrics to collect"
        },
        "traces": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Traces to capture"
        }
      }
    },
    "migrations": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Migration steps"
    },
    "rollback": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Rollback steps"
    }
  },
  "additionalProperties": false
}